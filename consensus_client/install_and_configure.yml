---
- hosts: all
  become: yes
  vars:
    docker_compose_version: "1.27.4"
  tasks:

    - name: Upgrade all apt packages
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install dependencies
      apt:
        name: "{{ packages }}"
        state: present
        update_cache: yes
      vars:
        packages:
        - apt-transport-https
        - ca-certificates
        - curl
        - software-properties-common
        - gnupg-agent

    - name: Add an apt signing key for Docker
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: Add apt repository for stable version
      apt_repository:
        repo: deb [arch=amd64] https://download.docker.com/linux/ubuntu focal stable
        state: present

    - name: Install Docker
      apt:
        name: "{{ packages }}"
        state: present
        update_cache: yes
      vars:
        packages:
        - docker-ce
        - docker-ce-cli
        - containerd.io

    - name: Allow 'beaconnode' user to have passwordless sudo
      lineinfile:
        dest: /etc/sudoers
        state: present
        regexp: '^%beaconnode'
        line: '%beaconnode ALL=(ALL) NOPASSWD: ALL'
        validate: 'visudo -cf %s'

    - name: Add sudoers users to docker group
      user:
        name=beaconnode
        groups=docker
        append=yes
        state=present
        createhome=yes

    - name: Download docker-compose {{ docker_compose_version }}
      get_url:
        url : https://github.com/docker/compose/releases/download/{{ docker_compose_version }}/docker-compose-Linux-x86_64
        dest: ~/docker-compose
        mode: '+x'

    - name: Check docker-compose exists
      stat: path=~/docker-compose
      register: docker_compose

    - name: Move docker-compose to /usr/local/bin/docker-compose
      command: mv ~/docker-compose /usr/local/bin/docker-compose
      when: docker_compose.stat.exists

    - name: Clone a github repository
      git:
        repo: https://github.com/eth2-educators/eth-docker.git
        dest: /home/beaconnode/eth
        clone: yes
        update: yes
      become: yes
      become_user: beaconnode

    - name: Copy file with owner and permissions
      ansible.builtin.copy:
        remote_src: yes
        src: /home/beaconnode/eth/default.env
        dest: /home/beaconnode/eth/.env
        owner: beaconnode
        group: docker
        mode: '0644'
      become: yes
      become_user: beaconnode

    - name: configure .env file - COMPOSE_FILE
      replace:
        path: /home/beaconnode/eth/.env
        regexp: 'COMPOSE_FILE=teku-base.yml:geth.yml'
        replace: "COMPOSE_FILE=lh-consensus.yml:traefik-cf.yml"
      become: yes
      become_user: beaconnode
    - name: configure .env file - EC_NODE
      replace:
        path: /home/beaconnode/eth/.env
        regexp: 'EC_NODE=http://execution:8545'
        replace: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          34313032353833633665643064346131333465363537383262643832366237663639313339663835
          3038353664323231626138363332373438373261366436630a396231313234333430373138303362
          34396334616664663436386637336633316636303566613433303662336530396662626233633461
          3636323365346265370a646266333437306461323563316163326530353838343233626138386363
          39396136326536393836663563656133633931323830303432363535636434626632343536346363
          37363130346134626636613033636139306535363163383462346461316334333965383261323566
          39383731646534323532373839656662616230363166626262336463343663353066626138666437
          32656231303862313536346163613734666662663363316362353961383766383531646466363565
          33623437343530386434636136373137346438356435616631363665363835326663323862343531
          32623637646338326338626235656130656539323931633534626136316438633630313131626662
          336364663762323865636638626636323134
      become: yes
      become_user: beaconnode
    - name: configure .env file - NETWORK
      replace:
        path: /home/beaconnode/eth/.env
        regexp: 'NETWORK=prater'
        replace: "NETWORK=prater"
      become: yes
      become_user: beaconnode
    - name: configure .env file - EC_NETWORK
      replace:
        path: /home/beaconnode/eth/.env
        regexp: 'EC_NETWORK=goerli'
        replace: "EC_NETWORK=goerli"
      become: yes
      become_user: beaconnode
    - name: configure .env file - DOMAIN
      replace:
        path: /home/beaconnode/eth/.env
        regexp: 'DOMAIN=example.com'
        replace: "DOMAIN=baramio-nodes.com"
      become: yes
      become_user: beaconnode
    - name: configure .env file - ACME_EMAIL
      replace:
        path: /home/beaconnode/eth/.env
        regexp: 'ACME_EMAIL=user@example.com'
        replace: "ACME_EMAIL=joseph@baramio.com"
      become: yes
      become_user: beaconnode
    - name: configure .env file - CF_EMAIL
      replace:
        path: /home/beaconnode/eth/.env
        regexp: 'CF_EMAIL=user@example.com'
        replace: "CF_EMAIL=joseph@baramio.com"
      become: yes
      become_user: beaconnode
    - name: configure .env file - CF_API_TOKEN
      replace:
        path: /home/beaconnode/eth/.env
        regexp: 'CF_API_TOKEN=SECRETTOKEN'
        replace: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          36326438396632343936643133623961633435303833333762626132353561636564343365653832
          3663333235383262333736613566323338396463333163370a656362393932373939663064343965
          66356565636132353036346362383930366266363331346661633636326631333139663061333039
          3537386562653331660a613661396632336230313630623131363239356339636630643030366133
          65663831653266636536616133333934316638306138303063326465663739613562636631303564
          37383039623636343130326134653931366139653633666138346339353537346563373132323366
          363636313461386561356161363731663934
      become: yes
      become_user: beaconnode
    - name: configure .env file - CC_HOST
      replace:
        path: /home/beaconnode/eth/.env
        regexp: 'CC_HOST=cc'
        replace: "CC_HOST={{ cc_host }}"
      become: yes
      become_user: beaconnode
    - name: configure .env file - LH_RAPID_SYNC
      replace:
        path: /home/beaconnode/eth/.env
        regexp: 'LH_RAPID_SYNC='
        replace: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          33333633663236386638336133386466613231383836353165633431346562306261643161616335
          3234613536373464313738616435306263333436336566640a616130303539316430653361353737
          66383835323761363033333634393538626461643464353265616431316464303736366230653930
          3230353766643238390a633139363430663134396131346463616634666239653732336563316130
          64343162653136303135633230653638363463396230643438383536323965616239393137303665
          39653832653330313831303162323264393438633362633166366132346338373838346538366430
          63663035356138616637646662316565366131373832643036343138386466353438623339376438
          37626635363933393564623966646665306166633332346531636137363762666338373133343437
          32386530616465636537333066636561613235613935623535663561623065666662356334623630
          62376461393535643137346531393731346535393139663562313832653630653337643666623932
          353536633364613363313038656163306538
      become: yes
      become_user: beaconnode

    - name: switch off the built in time synchronization. Ignore result if already turned off
      shell: timedatectl set-ntp no
      ignore_errors: yes

    - name: install ntp
      apt:
        name: "ntp"
        state: present
        update_cache: yes

    - name: Make sure NTP is started up
      service:
        name: ntp
        state: started
        enabled: yes

    - name: Go to the eth folder and execute command
      command: chdir=/home/beaconnode/eth docker-compose build --pull
      become: yes
      become_user: beaconnode

    - name: Start the beaconnode service
      command: chdir=/home/beaconnode/eth ./ethd start
      become: yes
      become_user: beaconnode
