#cloud-config
groups:
  - ubuntu: [root,sys]
  - docker

# Add users to the system. Users are added after groups are added.
users:
  - default
  - name: ec
    gecos: ec
    shell: /bin/bash
    primary_group: docker
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: users, admin
    lock_passwd: false
    ssh_authorized_keys:
      - ${ssh_public_key}

runcmd:
  - sudo apt update && sudo apt -y dist-upgrade
  - sudo apt install -y docker-compose
  - sudo systemctl enable --now docker
  - sudo wget -O /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/3.3.0/yq_linux_amd64
  - sudo chmod +x /usr/local/bin/yq
  - git clone https://github.com/eth-educators/eth-docker.git
  - mkdir /home/ec/eth-docker
  - mv /eth-docker/* /home/ec/eth-docker/
  - cp /home/ec/eth-docker/default.env /home/ec/eth-docker/.env
  - sed -i 's/COMPOSE_FILE=teku-base.yml:geth.yml/COMPOSE_FILE=geth.yml/g' /home/ec/eth-docker/.env
  - sed -i 's/EC_NETWORK=goerli/EC_NETWORK=rinkeby/g' /home/ec/eth-docker/.env
  - yq w -i /home/ec/eth-docker/geth.yml eth.image tianon/true
  - yq w -i /home/ec/eth-docker/geth.yml eth.restart "no""
  - chown ec:docker -R /home/ec/eth-docker
  - sudo timedatectl set-ntp no
  - sudo apt update && sudo apt install ntp -y
  - cd /home/ec/eth-docker && docker-compose build --pull
  - cd /home/ec/eth-docker && ./ethd start